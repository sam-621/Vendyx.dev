/// A shipment is the total price of the shipping method rate
model Shipment {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @default(now()) @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  /// Amount of the shipment collected from the customer
  amount       Int
  /// Method name that was used to create the shipment. We do not reference the ShippingMethod here because the method can be deleted.
  method       String
  /// Tracking code of the shipment retrieved from the carrier
  trackingCode String? @map("tracking_code")
  /// Carrier name that was used to create the shipment
  carrier      String?

  Order Order[]

  shop   Shop   @relation(fields: [shopId], references: [id])
  shopId String @default(dbgenerated("(current_setting('app.current_shop_id'::text))::uuid")) @map("shop_id") @db.Uuid

  @@map("shipment")
}

/// A shipping method is a method that your shop uses to calculate shipping rates
model ShippingMethod {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @default(now()) @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  /// The shipping method's name, meant to be displayed to the customer at checkout
  name            String
  /// The shipping method's description, meant to be displayed to the customer at checkout
  description     String?
  /// Whether the shipping method is enabled or not, used to show/hide the method at checkout
  enabled         Boolean @default(true)
  /// Metadata only used by the handler
  handlerMetadata Json    @map("handler_metadata")

  zone              Zone            @relation(fields: [zoneId], references: [id])
  zoneId            String          @db.Uuid
  shippingHandler   ShippingHandler @relation(fields: [shippingHandlerId], references: [id])
  shippingHandlerId String          @map("shipping_handler_id") @db.Uuid

  shop   Shop   @relation(fields: [shopId], references: [id])
  shopId String @default(dbgenerated("(current_setting('app.current_shop_id'::text))::uuid")) @map("shop_id") @db.Uuid

  @@map("shipping_method")
}

/// A shipping handler is a service that is used to calculate shipping rates and create shipments
model ShippingHandler {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @default(now()) @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  /// The shipping handler's name. This is used to identify the handler in the system
  name        String
  /// The shipping handler's code. This is used to identify which handler is used in the order_flow
  handlerCode String @unique @map("handler_code")
  /// Metadata definition, used to define the metadata that the handler requires (api keys, etc)
  metadata    Json

  shippingMethods ShippingMethod[]

  @@map("shipping_handler")
}

/// A zone is a collection of states that are used to group shipping rates
model Zone {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @default(now()) @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  /// The zone's name. This is used to identify the zone in the system
  name String

  shippingMethods ShippingMethod[]
  states          StateZone[]

  shop   Shop   @relation(fields: [shopId], references: [id])
  shopId String @default(dbgenerated("(current_setting('app.current_shop_id'::text))::uuid")) @map("shop_id") @db.Uuid

  @@map("zone")
}

model StateZone {
  zone   Zone   @relation(fields: [zoneId], references: [id])
  zoneId String @map("zone_id") @db.Uuid

  state   State  @relation(fields: [stateId], references: [id])
  stateId String @map("state_id") @db.Uuid

  @@id([zoneId, stateId])
  @@map("state_zone")
}
